# AIR8000 接口文档

## 概述

本文档详细描述 AIR8000 模块与 Hi3516cv610 之间的通信接口，基于 V1.0 帧协议。文档包含所有命令码的定义、数据格式、响应格式以及使用示例。

## 帧协议格式

### 基本帧格式

```
[0xAA][0x55][VER][TYPE][SEQ][CMD_H][CMD_L][LEN_H][LEN_L][DATA...][CRC_H][CRC_L]
```

- **SYNC1 (1字节)**：帧同步头，固定为 0xAA
- **SYNC2 (1字节)**：帧同步头，固定为 0x55
- **VER (1字节)**：协议版本，当前为 0x10 (V1.0)
- **TYPE (1字节)**：帧类型
  - 0x00: REQUEST - 请求帧
  - 0x01: RESPONSE - 响应帧
  - 0x02: NOTIFY - 通知帧
  - 0x03: ACK - 确认帧
  - 0x04: NACK - 否定确认帧
- **SEQ (1字节)**：序列号，用于匹配请求和响应
- **CMD (2字节)**：命令码，大端序
- **LEN (2字节)**：数据长度，大端序
- **DATA (变长)**：命令数据
- **CRC (2字节)**：CRC-16/MODBUS 校验，大端序

### 校验算法

使用 CRC-16/MODBUS 算法，多项式为 0x8005，初始值为 0xFFFF，结果取反。

## 命令码定义

### 系统命令 (0x00xx)

| 命令码 | 名称 | 功能描述 | 数据格式 | 响应格式 |
|--------|------|----------|----------|----------|
| 0x0001 | SYS_PING | 系统心跳检测 | 无 | ACK |
| 0x0002 | SYS_VERSION | 查询系统版本 | 无 | [major u8][minor_h u8][minor_l u8][patch_h u8][patch_l u8][project_len u8][project string][version string] |
| 0x0003 | SYS_RESET | 系统重启 | 无 | ACK |
| 0x0004 | SYS_RESET_HOST | 通知主机重启 | 无 | ACK |
| 0x0006 | SYS_HB_WDT_CONFIG | 心跳看门狗配置 | 无 | 无 |
| 0x0007 | SYS_HB_WDT_STATUS | 心跳看门狗状态查询 | 无 | 无 |
| 0x0008 | SYS_HB_POWEROFF | 心跳超时断电前通知 | 无 | 无 |

### 查询命令 (0x01xx)

| 命令码 | 名称 | 功能描述 | 数据格式 | 响应格式 |
|--------|------|----------|----------|----------|
| 0x0101 | QUERY_POWER | 查询电源电压 | 无 | [vbatt_h u8][vbatt_l u8][v12_h u8][v12_l u8] |
| 0x0102 | QUERY_STATUS | 查询系统状态 | 无 | 无 |
| 0x0103 | QUERY_NETWORK | 查询网络状态 | 无 | [csq u8][rssi u8][rsrp u8][status u8][operator u8][iccid 20字节][ip string] |

### 电机命令 (0x30xx)

| 命令码 | 名称 | 功能描述 | 数据格式 | 响应格式 |
|--------|------|----------|----------|----------|
| 0x3001 | MOTOR_ROTATE | 电机旋转 | [motor_id u8][angle f32 大端][velocity f32 大端] | [motor_id u8] |
| 0x3002 | MOTOR_ENABLE | 电机使能 | [motor_id u8][mode u8] | [motor_id u8] |
| 0x3003 | MOTOR_DISABLE | 电机禁用 | [motor_id u8] | [motor_id u8] |
| 0x3004 | MOTOR_STOP | 电机急停 | [motor_id u8] | [motor_id u8][success_count u8] |
| 0x3005 | MOTOR_SET_ORIGIN | 电机设置原点 | [motor_id u8] | [motor_id u8] |
| 0x3006 | MOTOR_GET_POS | 电机查询位置 | [motor_id u8] | [motor_id u8][position f32 大端序] |
| 0x3007 | MOTOR_SET_VEL | 电机设置速度 | [motor_id u8][velocity f32 大端] | [motor_id u8] |
| 0x3008 | MOTOR_ROTATE_REL | 电机相对旋转 | [motor_id u8][angle_delta f32 大端][velocity f32 大端] | [motor_id u8] |
| 0x3010 | MOTOR_GET_ALL | 查询所有电机状态 | 无 | [motor_count u8][motor1_state][motor2_state]... |

### 电机参数命令 (0x31xx)

| 命令码 | 名称 | 功能描述 | 数据格式 | 响应格式 |
|--------|------|----------|----------|----------|
| 0x3101 | MOTOR_READ_REG | 读取电机寄存器 | [motor_id u8][reg_id u8] | [motor_id u8][reg_id u8][value f32 大端序] |
| 0x3102 | MOTOR_WRITE_REG | 写入电机寄存器 | [motor_id u8][reg_id u8][value f32 大端序] | [motor_id u8][reg_id u8] |
| 0x3103 | MOTOR_SAVE_FLASH | 保存参数到Flash | [motor_id u8] | [motor_id u8] |
| 0x3104 | MOTOR_REFRESH | 刷新电机状态 | [motor_id u8] | [motor_id u8][position f32][velocity f32][torque f32][temp_mos u8][temp_rotor u8][error u8][enabled u8] |
| 0x3105 | MOTOR_CLEAR_ERROR | 清除电机错误 | [motor_id u8] | [motor_id u8] |

### 传感器命令 (0x40xx)

| 命令码 | 名称 | 功能描述 | 数据格式 | 响应格式 |
|--------|------|----------|----------|----------|
| 0x4001 | SENSOR_READ_TEMP | 读取温度 | [sensor_id u8] | [sensor_id u8][temperature f32 大端序] |
| 0x4002 | SENSOR_READ_ALL | 读取所有传感器 | 无 | [temp_h u8][temp_l u8][humidity u8][light u8][battery u8] |
| 0x4003 | SENSOR_READ_BME280 | 读取BME280传感器 | 无 | [temp f32 大端][press f32 大端][hum f32 大端] |
| 0x4004 | LED_SET_COLOR | 设置三色灯颜色 | [r u8][g u8][b u8] | ACK |

### 设备控制命令 (0x50xx)

| 命令码 | 名称 | 功能描述 | 数据格式 | 响应格式 |
|--------|------|----------|----------|----------|
| 0x5001 | DEV_HEATER | 加热器控制 | [device_id u8][state u8] | ACK |
| 0x5002 | DEV_FAN | 风扇控制 | [device_id u8][state u8] | ACK |
| 0x5003 | DEV_LED | LED控制 | [device_id u8][state u8] | ACK |
| 0x5004 | DEV_LASER | 激光控制 | [device_id u8][state u8] | ACK |
| 0x5005 | DEV_PWM_LIGHT | PWM补光灯控制 | [device_id u8][brightness u8] | ACK |
| 0x5006 | DEV_MOTOR_POWER | 电机供电控制 | [power_state u8] | ACK |
| 0x5010 | DEV_GET_STATE | 设备状态查询 | [device_id u8] | [state u8] |

### OTA升级命令 (0x60xx)

| 命令码 | 名称 | 功能描述 | 数据格式 | 响应格式 |
|--------|------|----------|----------|----------|
| 0x6001 | OTA_START | 启动OTA升级 | [URL string] | ACK |
| 0x6002 | OTA_STATUS | 查询OTA状态 | 无 | [status u8][error_code u8] |
| 0x6003 | OTA_VERSION | 查询版本信息 | 无 | [project_len u8][project string][version string] |

### 文件传输命令 (0x602x)

| 命令码 | 名称 | 功能描述 | 数据格式 | 响应格式 |
|--------|------|----------|----------|----------|
| 0x6020 | FILE_TRANSFER_REQUEST | 文件传输请求 | [filename string] | ACK |
| 0x6021 | FILE_TRANSFER_ACK | 文件传输确认 | [block_index u32 大端序] | ACK |
| 0x6022 | FILE_TRANSFER_COMPLETE | 文件传输完成 | [crc32 u32 大端序] | ACK |
| 0x6023 | FILE_TRANSFER_ERROR | 文件传输错误 | [error_code u32 大端序] | ACK |
| 0x6024 | FILE_TRANSFER_CANCEL | 文件传输取消 | 无 | ACK |
| 0x6026 | FILE_TRANSFER_STATUS | 文件传输状态通知 | 无 | 无 |

### 串口FOTA升级命令 (0x601x)

| 命令码 | 名称 | 功能描述 | 数据格式 | 响应格式 |
|--------|------|----------|----------|----------|
| 0x6010 | OTA_UART_START | 开始串口升级 | [firmware_size u32 大端序] | ACK |
| 0x6011 | OTA_UART_DATA | 固件数据包 | [seq u16 大端序][firmware_data...] | ACK |
| 0x6012 | OTA_UART_FINISH | 升级完成 | 无 | ACK |
| 0x6013 | OTA_UART_ABORT | 取消升级 | 无 | ACK |
| 0x6014 | OTA_UART_STATUS | 串口升级状态通知 | 无 | 无 |

### 网络配置命令 (0x70xx)

| 命令码 | 名称 | 功能描述 | 数据格式 | 响应格式 |
|--------|------|----------|----------|----------|
| 0x7001 | NET_SET_APN | 设置APN | [apn_len u8][apn][user_len u8][user][pwd_len u8][pwd] | ACK |
| 0x7002 | NET_GET_APN | 查询APN配置 | 无 | [apn_len u8][apn][user_len u8][user][pwd_len u8][pwd] |
| 0x7003 | NET_GET_STATUS | 查询网络状态(详细) | 无 | [status u8][csq u8][rssi i8][rsrp i16 大端][snr i8][operator u8][ip_len u8][ip string] |
| 0x7004 | NET_RESET | 重置网络连接 | 无 | ACK |

## 详细命令说明

### 系统命令

#### SYS_PING (0x0001)

- **功能**：系统心跳检测，用于确认通信链路正常
- **数据格式**：无
- **响应格式**：ACK 帧
- **使用示例**：
  ```
  发送：AA 55 10 00 01 00 01 00 00 CRC
  接收：AA 55 10 03 01 00 01 00 00 CRC
  ```

#### SYS_VERSION (0x0002)

- **功能**：查询系统版本信息
- **数据格式**：无
- **响应格式**：
  - [major u8]：主版本号
  - [minor_h u8][minor_l u8]：次版本号（16位）
  - [patch_h u8][patch_l u8]：补丁版本号（16位）
  - [project_len u8]：项目名称长度
  - [project string]：项目名称
  - [version string]：版本字符串
- **使用示例**：
  ```
  发送：AA 55 10 00 02 00 02 00 00 CRC
  接收：AA 55 10 01 02 00 02 XX XX XX XX XX XX XX ... CRC
  ```

### 电机命令

#### MOTOR_ROTATE (0x3001)

- **功能**：控制电机旋转到指定角度
- **数据格式**：
  - [motor_id u8]：电机ID（1-4）
  - [angle f32 大端]：目标角度（弧度）
  - [velocity f32 大端]：旋转速度（弧度/秒）
- **响应格式**：
  - [motor_id u8]：电机ID
- **使用示例**：
  ```
  发送：AA 55 10 00 03 30 01 00 09 01 XX XX XX XX XX XX XX XX CRC
  接收：AA 55 10 01 03 30 01 00 01 01 CRC
  ```

#### MOTOR_ENABLE (0x3002)

- **功能**：使能电机，设置控制模式
- **数据格式**：
  - [motor_id u8]：电机ID（1-4）
  - [mode u8]：控制模式（1=MIT, 2=位置速度, 3=速度）
- **响应格式**：
  - [motor_id u8]：电机ID
- **使用示例**：
  ```
  发送：AA 55 10 00 04 30 02 00 02 01 02 CRC
  接收：AA 55 10 01 04 30 02 00 01 01 CRC
  ```

#### MOTOR_STOP (0x3004)

- **功能**：电机急停
- **数据格式**：
  - [motor_id u8]：电机ID（1-4，0xFF表示所有电机）
- **响应格式**：
  - [motor_id u8]：电机ID
  - [success_count u8]：成功停止的电机数量（当motor_id=0xFF时）
- **使用示例**：
  ```
  发送：AA 55 10 00 05 30 04 00 01 FF CRC
  接收：AA 55 10 01 05 30 04 00 02 FF 04 CRC
  ```

### 传感器命令

#### SENSOR_READ_TEMP (0x4001)

- **功能**：读取温度传感器数据
- **数据格式**：
  - [sensor_id u8]：传感器ID（0表示DS18B20）
- **响应格式**：
  - [sensor_id u8]：传感器ID
  - [temperature f32 大端序]：温度值（摄氏度）
- **使用示例**：
  ```
  发送：AA 55 10 00 06 40 01 00 01 00 CRC
  接收：AA 55 10 01 06 40 01 00 05 00 XX XX XX XX CRC
  ```

#### SENSOR_READ_BME280 (0x4003)

- **功能**：读取BME280温湿度气压传感器数据
- **数据格式**：无
- **响应格式**：
  - [temp f32 大端]：温度值（摄氏度）
  - [press f32 大端]：气压值（百帕）
  - [hum f32 大端]：湿度值（百分比）
- **使用示例**：
  ```
  发送：AA 55 10 00 07 40 03 00 00 CRC
  接收：AA 55 10 01 07 40 03 00 0C XX XX XX XX XX XX XX XX XX XX XX XX CRC
  ```

### 设备控制命令

#### DEV_FAN (0x5002)

- **功能**：控制风扇
- **数据格式**：
  - [device_id u8]：设备ID（0表示默认设备）
  - [state u8]：状态（0=关闭，1=开启）
- **响应格式**：ACK 帧
- **使用示例**：
  ```
  发送：AA 55 10 00 08 50 02 00 02 00 01 CRC
  接收：AA 55 10 03 08 50 02 00 00 CRC
  ```

#### DEV_LED (0x5003)

- **功能**：控制LED
- **数据格式**：
  - [device_id u8]：设备ID（0表示默认设备）
  - [state u8]：状态（0=关闭，1=电源LED亮，2=网络LED亮，3=全部亮）
- **响应格式**：ACK 帧
- **使用示例**：
  ```
  发送：AA 55 10 00 09 50 03 00 02 00 03 CRC
  接收：AA 55 10 03 09 50 03 00 00 CRC
  ```

### OTA升级命令

#### OTA_START (0x6001)

- **功能**：启动网络OTA升级
- **数据格式**：
  - [URL string]：固件升级包的HTTP URL
- **响应格式**：ACK 帧
- **使用示例**：
  ```
  发送：AA 55 10 00 0A 60 01 00 XX URL... CRC
  接收：AA 55 10 03 0A 60 01 00 00 CRC
  ```

#### OTA_STATUS (0x6002)

- **功能**：查询OTA升级状态
- **数据格式**：无
- **响应格式**：
  - [status u8]：升级状态
  - [error_code u8]：错误码
- **使用示例**：
  ```
  发送：AA 55 10 00 0B 60 02 00 00 CRC
  接收：AA 55 10 01 0B 60 02 00 02 01 00 CRC
  ```

### 文件传输命令

#### FILE_TRANSFER_REQUEST (0x6020)

- **功能**：请求Air8000发送文件
- **数据格式**：
  - [filename string]：文件名
- **响应格式**：ACK 帧
- **使用示例**：
  ```
  发送：AA 55 10 00 0C 60 20 00 XX filename... CRC
  接收：AA 55 10 03 0C 60 20 00 00 CRC
  ```

### 网络配置命令

#### NET_SET_APN (0x7001)

- **功能**：设置APN配置
- **数据格式**：
  - [apn_len u8]：APN长度
  - [apn string]：APN名称
  - [user_len u8]：用户名长度
  - [user string]：用户名
  - [pwd_len u8]：密码长度
  - [pwd string]：密码
- **响应格式**：ACK 帧
- **使用示例**：
  ```
  发送：AA 55 10 00 0D 70 01 00 XX len apn len user len pwd CRC
  接收：AA 55 10 03 0D 70 01 00 00 CRC
  ```

## 错误码定义

| 错误码 | 名称 | 描述 |
|--------|------|------|
| 0x01 | UNKNOWN_CMD | 未知命令 |
| 0x02 | INVALID_PARAM | 参数无效 |
| 0x03 | DEVICE_BUSY | 设备忙 |
| 0x04 | NOT_READY | 设备未就绪 |
| 0x05 | EXEC_FAILED | 执行失败 |
| 0x06 | TIMEOUT | 超时 |
| 0x07 | CRC_ERROR | CRC校验错误 |
| 0x08 | VERSION_UNSUPPORTED | 版本不支持 |

## 状态通知

### OTA状态通知

- **命令码**：0x6002
- **通知数据**：
  - [status u8]：升级状态
  - [error_code u8]：错误码

### 串口FOTA状态通知

- **命令码**：0x6014
- **通知数据**：
  - [status u8]：升级状态
  - [error_code u8]：错误码
  - [progress u8]：升级进度（0-100）

### 文件传输状态通知

- **命令码**：0x6026
- **通知数据**：
  - [status u8]：传输状态
  - [error_code u8]：错误码
  - [progress u8]：传输进度（0-100）

## 数据类型说明

### 数值类型

- **u8**：无符号8位整数（1字节）
- **u16**：无符号16位整数（2字节，大端序）
- **u32**：无符号32位整数（4字节，大端序）
- **f32**：单精度浮点数（4字节，大端序）
- **i8**：有符号8位整数（1字节）
- **i16**：有符号16位整数（2字节，大端序）

### 字符串类型

- **string**：变长字符串，无终止符，长度由前导长度字段指定

## 使用建议

1. **命令序列**：对于需要多步操作的任务，建议按以下序列执行：
   - 电机操作：先使能电机，再进行控制操作
   - OTA升级：先查询版本，再启动升级，最后查询状态

2. **错误处理**：收到NACK帧时，应根据错误码进行相应处理：
   - UNKNOWN_CMD：检查命令码是否正确
   - INVALID_PARAM：检查参数格式是否正确
   - TIMEOUT：重试命令或检查硬件连接

3. **通信效率**：
   - 对于频繁查询的状态，建议使用定时轮询
   - 对于批量操作，优先使用支持批量处理的命令（如MOTOR_STOP 0xFF）

4. **安全性**：
   - OTA升级时确保固件来源可信
   - 文件传输时验证文件完整性

## 版本兼容性

- **协议版本**：V1.0
- **软件版本**：000.500.002

本文档适用于当前版本的AIR8000固件，未来版本可能会增加新的命令或修改现有命令的行为，请以实际固件为准。

---

*本文档仅供参考，具体功能以实际代码为准。*