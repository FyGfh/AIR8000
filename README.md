# AIR8000 项目文档

## 项目概述

AIR8000 是一个基于 Air8000 模块的双通道通信系统，实现与 Hi3516cv610 的高效通信和控制。

**核心功能：**
- **USB RNDIS 网络透传**：共享 4G 网络给 Hi3516cv610
- **USB 虚拟串口通信**：基于 V1.0 帧协议的命令控制和状态查询
- **电机控制**：支持 CAN 总线电机的使能、旋转、速度控制等操作
- **传感器数据采集**：支持 DS18B20 温度传感器和 BME280 温湿度气压传感器
- **设备控制**：支持风扇、加热器、LED 等设备的控制
- **OTA 升级**：支持网络 OTA 和串口 FOTA 两种升级方式
- **文件传输**：支持与 Hi3516cv610 之间的文件传输

## 项目结构

```
AIR8000/
├── src/              # 源代码目录
│   ├── main.lua      # 主程序入口
│   ├── network_config.lua  # 网络配置模块
│   ├── usb_vuart_comm.lua  # USB 虚拟串口通信模块
│   ├── dm_motor_bridge.lua # DM 电机驱动桥接模块
│   ├── dm_can_motor.lua    # DM CAN 电机控制模块
│   ├── ds18b20_sensor.lua  # DS18B20 温度传感器模块
│   ├── bmx_sensor.lua      # BME280 传感器模块
│   ├── ota_update.lua      # OTA 升级模块
│   ├── uart_fota.lua       # 串口 FOTA 升级模块
│   ├── file_transfer.lua   # 文件传输模块
│   ├── mqtt_client.lua     # MQTT 客户端模块
│   ├── http_upload.lua     # HTTP 上传模块
│   ├── cam_sensor.lua      # 摄像头传感器模块
│   └── pins_air8000t.json  # 引脚配置文件
├── docs/             # 文档目录
│   ├── 8000管脚映射表 -CV610订制(1).xlsx  # 管脚映射表
│   └── protocol/      # 协议文档目录
│       ├── DM_MOTOR_PROTOCOL.md  # DM 电机协议
│       └── PROTOCOL.md           # 通信协议
└── refer/            # 参考代码
    └── mqtt/         # MQTT 相关示例代码
```

## 系统架构

### 通信架构

AIR8000 系统与 Hi3516cv610 通过两条通道通信：

1. **USB RNDIS 通道**：用于网络数据传输，共享 4G 网络
2. **USB 虚拟串口通道**：用于命令控制和状态查询，基于 V1.0 帧协议

### 帧协议格式

```
[0xAA][0x55][VER][TYPE][SEQ][CMD_H][CMD_L][LEN_H][LEN_L][DATA...][CRC_H][CRC_L]
```

- **VER**：协议版本，当前为 0x10 (V1.0)
- **TYPE**：帧类型（REQUEST/RESPONSE/NOTIFY/ACK/NACK）
- **SEQ**：序列号
- **CMD**：16 位命令码
- **LEN**：数据长度
- **DATA**：数据内容
- **CRC**：CRC-16/MODBUS 校验

## 核心功能

### 1. 网络配置

- **APN 配置**：支持自定义 APN，保存在 fskv 中，重启后自动加载
- **USB 以太网模式**：支持 ECM 和 RNDIS 两种模式，支持 NAT 和独立 IP 配置
- **网络状态查询**：提供详细的网络状态信息，包括信号强度、运营商等

### 2. 电机控制

- **电机使能/禁用**：支持多种控制模式（MIT、位置速度、速度）
- **电机旋转**：支持绝对位置和相对位置控制
- **速度控制**：支持直接设置电机速度
- **急停功能**：支持单个电机和所有电机的急停
- **位置查询**：实时读取电机位置
- **参数配置**：支持读取和写入电机寄存器参数

### 3. 传感器数据

- **DS18B20 温度传感器**：读取环境温度
- **BME280 传感器**：读取温度、湿度和气压
- **CPU 温度**：读取设备 CPU 温度

### 4. 设备控制

- **风扇控制**：支持手动和自动温度控制
- **加热器控制**：支持手动控制
- **LED 控制**：控制电源状态 LED 和网络状态 LED
- **激光控制**：预留激光控制接口
- **PWM 补光灯控制**：预留 PWM 补光灯控制接口
- **电机供电控制**：控制电机电源的开启和关闭

### 5. OTA 升级

- **网络 OTA**：通过 HTTP URL 进行固件升级
- **串口 FOTA**：通过 USB 虚拟串口进行固件升级
- **升级状态通知**：实时通知升级状态变化

### 6. 文件传输

- **文件传输请求**：Hi3516cv610 请求 Air8000 发送文件
- **分片传输**：支持大文件的分片传输
- **传输状态通知**：实时通知文件传输状态

## 快速开始

### 硬件连接

1. **电源连接**：确保 AIR8000 模块和 Hi3516cv610 都有稳定的电源供应
2. **USB 连接**：使用 USB 线缆连接 AIR8000 和 Hi3516cv610
3. **CAN 总线连接**：如果使用电机控制功能，确保 CAN 总线正确连接
4. **传感器连接**：根据需要连接 DS18B20 和 BME280 传感器

### 软件配置

1. **APN 配置**：如果需要使用特定的 APN，在 `network_config.lua` 中设置或通过命令 `NET_SET_APN` 配置
2. **电机配置**：在 `main.lua` 中配置电机的 CAN ID
3. **传感器配置**：确保传感器正确连接，在 `main.lua` 中初始化

### 通信协议使用

Hi3516cv610 可以通过 USB 虚拟串口发送符合 V1.0 帧协议的命令来控制 AIR8000 模块，例如：

- **系统命令**：ping、版本查询、重启等
- **电机命令**：使能、旋转、速度控制等
- **传感器命令**：读取温度、湿度、气压等
- **设备命令**：控制风扇、加热器、LED 等
- **OTA 命令**：启动升级、查询状态等
- **文件传输命令**：请求文件、确认传输等

## 开发指南

### 代码结构

- **main.lua**：主程序入口，负责初始化各个模块和处理命令
- **network_config.lua**：网络配置模块，管理 APN 和 USB 以太网模式
- **usb_vuart_comm.lua**：USB 虚拟串口通信模块，实现 V1.0 帧协议
- **传感器模块**：负责读取各种传感器数据
- **电机控制模块**：负责控制 CAN 总线电机
- **OTA 模块**：负责固件升级功能
- **文件传输模块**：负责与 Hi3516cv610 之间的文件传输

### 命令扩展

如果需要添加新的命令，可以在 `usb_vuart_comm.lua` 中注册新的命令处理器：

```lua
usb_vuart.on_cmd(CMD.YOUR_NEW_COMMAND, function(seq, data)
    -- 处理命令
    return RESULT.ACK
end)
```

### 状态提供者注册

如果需要添加新的状态提供者，可以在 `main.lua` 中注册：

```lua
usb_vuart.register_status("your_status", function()
    -- 返回状态数据
    return status_data
end)
```

## 故障排除

### 网络连接问题

1. **检查 APN 配置**：确保 APN 配置正确
2. **检查 SIM 卡**：确保 SIM 卡正确插入，并且有足够的信号强度
3. **重置网络**：使用 `NET_RESET` 命令重置网络连接

### 电机控制问题

1. **检查 CAN 总线连接**：确保 CAN 总线正确连接
2. **检查电机 CAN ID**：确保电机的 CAN ID 与配置一致
3. **检查电机供电**：确保电机有足够的电源供应

### 传感器数据问题

1. **检查传感器连接**：确保传感器正确连接
2. **检查传感器初始化**：确保传感器在 `main.lua` 中正确初始化

### OTA 升级问题

1. **检查网络连接**：确保网络连接稳定
2. **检查固件文件**：确保固件文件正确，并且 URL 可访问
3. **检查文件传输**：确保文件传输过程中没有中断

## 版本信息

- **项目名称**：VDM_AIR8000
- **版本**：000.500.002
- **协议版本**：V1.0

## 联系方式

如果您在使用过程中遇到任何问题，请联系我们的技术支持团队。

---

*本文档仅供参考，具体功能以实际代码为准。*
